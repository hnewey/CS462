ruleset track_trips {
	meta {
		use module edmonds_keys
		use module edmonds_api
				with api_key = keys:edmonds("api_key")
	}

	global {
		long_trip = 20;
	}

	rule process_trips {
		select when car new_trip mileage re#^[+]?([.]\d+|\d+([.]\d+)?)$#
    pre {
      mileage = event:attr("mileage").defaultsTo("0");
    }
    send_directive("trip") with
				trip_length = mileage
		fired {
			raise explicit event "trip_processed"
				attributes { "attributes": event:attrs()}
		}
	}

	rule find_long_trips {
		select when explicit trip_processed
		pre {
			mileage = event:attr("mileage");
		}
		send_directive("attrs") with
				attrs = event:attr("attributes")
		if mileage < long_trip then
	    send_directive("mileageIs") with
				mileageVarIs = mileage
		fired {
    	raise explicit event "found_long_trip"
				attributes { "attrs": event:attrs()}
		}
	}

	rule trip_fuel_usage {
		select when explicit trip_processed
		pre {
			vehicleInfo = edmonds_api:find_vin(event:attr("vin").defaultsTo("JNKCV51E06M521497"));
		}
		send_directive("finding_vin") with
			finding_vin = true
	}
}
