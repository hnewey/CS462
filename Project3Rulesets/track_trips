ruleset track_trips {
	meta {
	}

	global {
		long_trip = 20;
	}

	rule process_trips {
		select when car new_trip mileage re#^[+]?([.]\d+|\d+([.]\d+)?)$#
    pre {
      mileage = event:attr("mileage").defaultsTo("0");
    }
    send_directive("trip") with
				trip_length = mileage
		fired {
			raise explicit event "trip_processed"
				attributes { "attrs": event:attrs()}
		}
	}

	rule find_long_trips {
		select when explicit trip_processed
		pre {
			mileage = event:attr("mileage");
		}
		if mileage > long_trip
			raise explicit event "found_long_trip"
				attributes { "attrs": event:attrs()}
	}
}
